<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play multiplayer 1v1 BATTLE with your friend! - Blocks' Fall.</title>
    <meta name="description"
        content="The Online Game for played Anyplace and Anytime. Enjoy this best puzzle game with your friend or solo. You will love it!">
    <meta name="application-name" content="Blocks' Fall">

    <meta property="og:title" content="1v1 BATTLE! - Blocks' Fall.">
    <meta property="og:type" content="game" />
    <meta property="og:image" content="https://blocksfall.io/1v1BattleLogo.png">
    <meta property="og:url" content="https://blocksfall.io/multiplayer">
    <meta property="og:description" content="Play multiplayer 1v1 BATTLE with your friend!">

    <meta name=”twitter:card” content=”summary” />
    <meta name="twitter:title" content="1v1 BATTLE! - Blocks' Fall.">
    <meta name="twitter:description" content="Play multiplayer 1v1 BATTLE with your friend!">
    <meta name="twitter:image" content="https://blocksfall.io/1v1BattleLogo.png">
    <meta name="twitter:url" content="https://blocksfall.io/multiplayer">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="./blocksfall-logo.png">
    <link rel="stylesheet" href="./style.css">
    <link href="./icons.css" rel="stylesheet">
    <link href="./FORCED-SQUARE.ttf" rel="stylesheet">
    <link rel="preload" href="./pause.html">
    <link rel="preload" href="./gameover.html">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4463881368194285"
        crossorigin="anonymous"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E8VQL8KMYB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-E8VQL8KMYB');
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-215656117-1">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-215656117-1');
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4463881368194285"
        crossorigin="anonymous"></script>
</head>

<body id="body" style="overflow: hidden;" onblur="ifOnBlur()" onclick="ifOnClicked()">

    <div class="container" style="flex-direction: row; flex-wrap: wrap;">
        <div class="main">

            <h2><i class='fas fa-user-circle'></i> USERNAME</h2>
            <h3 id="warning" style="margin: 0;"> </h3>
            <input class="input" MAXLENGTH="10" id="userName" name="userName" type="text" style="width: 35vmin;">
            <button class="btn" onclick="userConnected()"> <i class='fas fa-sign-in-alt'></i> JOIN </button>

        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        function scrollToElement(d) {
            if (d === "top") {
                window.scrollBy({
                    top: -1000,
                    behavior: 'smooth'
                });
            } else if (d === "bottom") {
                window.scrollBy({
                    top: 1000,
                    behavior: 'smooth'
                });
            }
        }

        let isOffline = null
        let socket = io('', {
            transports: ['websocket'],
        });

        let idClient = null

        // socket.on('connect', function () {
        //     idClient = socket.id;
        // })

        socket.on("disconnect", () => {
            if (rodando !== null) {
                clearInterval(rodando)
            }
            document.getElementsByClassName("container")[0].innerHTML = "<div class='main'><h1><i class='fas fa-exclamation-circle'></i> DISCONNECTED</h1></div>"
        })

        function userConnected() {
            let userName = document.getElementById("userName").value;
            if (userName === '') {
                document.getElementById("warning").innerHTML = "<i class='fas fa-exclamation-circle'></i> PLEASE ENTER A USERNAME.";
            }
            else {
                if (window.location.href.includes("?id=")) {
                    let gameId = window.location.href.split("?id=")[1];
                    gameId = parseInt(gameId);
                    socket.emit("userConnected", { userName, gameId })
                }
                else {
                    socket.emit("userConnected", { userName, gameId: -1 })
                }
            }

        }

        let gameId = null;
        let userId = null

        let playOnlineHtml = null
        getPlayOnlineHtml();

        function getPlayOnlineHtml() {
            let xmlHttp = new XMLHttpRequest();
            xmlHttp.responseType = "document";
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState !== 4 && xmlHttp.status !== 200) {
                    return false
                }
                else if (xmlHttp.response) {
                    playOnlineHtml = xmlHttp.response.getElementById('body');
                }
            }
            xmlHttp.open("GET", './playOnline.html', true); // true for asynchronous 
            xmlHttp.send(null);
        }

        socket.on("updateServer", msg => {
            if (rodando === null) {
                if (msg.isRunning === false && msg.winnerId === null) {
                    onUserList(msg)
                }
                else if (msg.isRunning === true) {
                    onStartGame(msg)
                }
            }
            else if (rodando !== null) {
                if (msg.isRunning === false) {
                    clearInterval(rodando)
                    rodando = null
                    if (msg.winnerId === null) {
                        onUserList(msg)
                    }
                    else {
                        onPlayerWinner(msg)
                    }
                }
                else if (msg.isRunning === true) {
                    onUpdateServer(msg)
                }
            }
        })


        function onStartGame(msg) {
            if (playOnlineHtml === null) {
                getPlayOnlineHtml();
            }
            document.getElementsByClassName("container")[0].innerHTML = playOnlineHtml.getElementsByClassName("container")[0].innerHTML;
            for (let x = 0; x < msg.users.length; x++) {
                if (socket.id !== msg.users[x].id) {
                    document.getElementById("game1UserName").innerHTML = msg.users[x].name;
                }
            }
            setMatrixOnline(msg.users)
        }

        socket.on("roomIsFull", () => {
            document.getElementById("warning").innerHTML = "<i class='fas fa-exclamation-circle'></i> ROOM IS FULL.";
        })


        function onUserList(msg) {
            gameId = msg.id;

            let divScoreAndMenu = document.createElement("div")
            divScoreAndMenu.className = "scoreAndMenu"
            divScoreAndMenu.style.flexDirection = "column"

            let pWaiting = document.createElement("h3")
            pWaiting.id = "pWaiting"

            let buttonStart = document.createElement("button")
            buttonStart.className = "btn"
            buttonStart.innerHTML = "<i class='fas fa-play'></i> START"
            buttonStart.setAttribute("onclick", "startGame()")

            for (let x = 0; x < msg.users.length; x++) {
                let p = document.createElement("p")
                p.innerHTML = " PLAYER " + (x + 1) + " - "
                p.className = "scoreShow player"
                if (msg.users[x].host === true) {
                    p.innerHTML += msg.users[x].name + " (HOST)"
                }
                else {
                    p.innerHTML += msg.users[x].name
                }
                if (msg.users[x].id === socket.id) {
                    p.style = "color: #FF9A00"
                }
                divScoreAndMenu.appendChild(p)
            }

            pWaiting.innerHTML = "<i class='fas fa-hourglass'></i> WAITING THE HOST..."


            for (let x = 0; x < msg.users.length; x++) {

                if (msg.users[x].id === socket.id && msg.users[x].host === true) {
                    if (msg.users.length === 1) {
                        pWaiting.innerHTML = "<i class='fas fa-hourglass'></i> WAITING FOR PLAYERS..."
                    }
                    if (msg.users.length > 1) {
                        pWaiting = buttonStart
                    }
                }
            }

            let roomId = document.createElement("h2")
            roomId.innerHTML = "<i class='fas fa-user-friends'></i>" + msg.users.length + "/2 - ROOM ID: " + msg.id

            let buttonShare = document.createElement("button")
            buttonShare.id = "share"
            buttonShare.setAttribute("onclick", "shareGame()")
            buttonShare.className = "btn"
            buttonShare.innerHTML = "<i class='fas fa-share'></i> SHARE"
            buttonShare.style.minWidth = "0"

            let divHeader = document.createElement("div")
            divHeader.style.display = "flex"
            divHeader.style.flexDirection = "row"
            divHeader.style.justifyContent = "space-eveliny"
            divHeader.style.alignItems = "center"

            divHeader.appendChild(roomId)
            divHeader.appendChild(buttonShare)

            if (document.getElementsByClassName("main")[0] !== undefined) {
                document.getElementsByClassName("main")[0].replaceChildren(divHeader)
                document.getElementsByClassName("main")[0].appendChild(divScoreAndMenu)
                document.getElementsByClassName("main")[0].appendChild(pWaiting)
            }
            else if (document.getElementsByClassName("hud")[0] !== undefined) {
                clearInterval(rodando)
                for (let x = 0; x < document.getElementsByClassName("hud")[0].parentNode.children.length; x++) {
                    document.getElementsByClassName("hud")[0].parentNode.children[x].remove()
                }
                document.getElementsByClassName("hud")[0].replaceChildren(divHeader)
                document.getElementsByClassName("hud")[0].appendChild(divScoreAndMenu)
                document.getElementsByClassName("hud")[0].appendChild(pWaiting)
                document.getElementsByClassName("hud")[0].className = "main"
            }

        }



        function shareGame() {
            if (navigator.share !== undefined) {
                navigator.share({
                    title: "Blocks' Fall",
                    text: "Can you play Blocks' Fall with me!?",
                    url: './multiplayer?id=' + gameId,
                })
                    .then(() => { })
                    .catch((error) => { });
            }
            else {
                let urlShare = window.location.origin + "/multiplayer?id=" + gameId;
                navigator.clipboard.writeText(urlShare)
                    .then(() => {
                        document.getElementById("share").innerHTML = "<i class='fas fa-check'></i> COPIED"
                    })
                    .catch((err) => {

                    });
            }
        }

        function startGame() {
            socket.emit("startClient", { gameId })
        }

        musicControl(true)

        function musicControl(firstTimeMusic = false) {
            if (sessionStorage.getItem('musicControl') === null && firstTimeMusic === true) {
                if (document.getElementById('music') === null) {
                    let music = document.createElement('audio')
                    music.src = "./music.mpeg"
                    music.id = "music"
                    music.autoplay = ' '
                    music.loop = ' '
                    document.getElementsByClassName('container')[0].parentNode.appendChild(music)

                }
            }

            if (sessionStorage.getItem('musicControl') === 'false') {

                if (document.getElementById("music")) {
                    document.getElementById('music').parentNode.removeChild(document.getElementById('music'))
                }
            }
            else if (sessionStorage.getItem('musicControl') === 'true') {


                if (document.getElementById('music') === null) {
                    let music = document.createElement('audio')
                    music.src = "./music.mpeg"
                    music.id = "music"
                    music.autoplay = ' '
                    music.loop = ' '
                    document.getElementsByClassName('container')[0].parentNode.appendChild(music)

                }

            }
        }

        function ifOnBlur() {
            if (sessionStorage.getItem('musicControl') === "true" || sessionStorage.getItem('musicControl') === null) {
                if (document.getElementById("music")) {
                    document.getElementById('music').parentNode.removeChild(document.getElementById('music'))
                }
            }
        }

        function ifOnClicked() {
            if (sessionStorage.getItem('musicControl') === "true" || sessionStorage.getItem('musicControl') === null) {
                if (document.getElementById("music") === null) {
                    let music = document.createElement('audio')
                    music.src = "./music.mpeg"
                    music.id = "music"
                    music.autoplay = ' '
                    music.loop = ' '
                    document.getElementsByClassName('container')[0].parentNode.appendChild(music)
                }

            }
        }



        let countOnlineSocket = 0
        let notDisconnected = setInterval(() => {
            countOnlineSocket++;
        }, 20000);

    </script>
    <script src="/game-online.js"></script>

</body>


</html>